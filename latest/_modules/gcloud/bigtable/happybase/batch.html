<!DOCTYPE html>


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>gcloud.bigtable.happybase.batch &mdash; gcloud aa56c9f documentation</title>
    
    <link rel="stylesheet" href="../../../../_static/css/main.css" type="text/css" />
    <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../../../_static/css/normalize.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../../',
        VERSION:     'aa56c9f',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../../_static/js/vendor/modernizr-2.6.2.min.js"></script>
    <link rel="shortcut icon" href="../../../../_static/favicon.ico"/>
    <link rel="top" title="gcloud aa56c9f documentation" href="../../../../index.html" />
    <link rel="up" title="Module code" href="../../../index.html" /> 
  </head>
  <body role="document">
    <header class="page-header fixed" role="banner">
      <h1 class="logo">
        <a href="index.html" title="back to home">
          <img src="../../../../_static/images/logo.svg" alt="Google Cloud Platform" />
          <span class="gcloud">gcloud</span>
        </a>
      </h1>
      <nav class="main-nav">
        <div class="nav-current">Python</div>
        <ul class="menu">
          <li>
            <a href="
https://googlecloudplatform.github.io/gcloud-java/" title="gcloud-java page">
              <img src="../../../../_static/images/icon-lang-java-duke.svg" alt="Duke icon" class="menu-icon" />
              Java
            </a>
          </li>
          <li>
            <a href="
https://googlecloudplatform.github.io/gcloud-node/#/docs" title="Node.js docs page">
              <img src="../../../../_static/images/icon-lang-nodejs.svg" alt="Node.js icon" class="menu-icon" />
              Node.js
            </a>
          </li>
          <li>
            <a href="#" title="Python docs page">
              <img src="../../../../_static/images/icon-lang-python.svg" alt="Python icon" class="menu-icon" />
              Python
            </a>
          </li>
          <li>
            <a href="
http://googlecloudplatform.github.io/gcloud-ruby/docs/latest" title="Ruby docs page">
              <img src="../../../../_static/images/icon-lang-ruby.svg" alt="Ruby icon" class="menu-icon" />
              Ruby
            </a>
          </li>
        </ul>
      </nav><!-- end of .main-nav -->
      <a href="https://github.com/GoogleCloudPlatform/gcloud-python/issues/new?title=%5BDocumentation+Issue%5D+&body=Page+Name%3A+_modules/gcloud/bigtable/happybase/batch%0ARelease%3A%20aa56c9f" target="_blank" class="v-btn" id="file-issue">
        <img src="_static/images/icon-link-github.svg" />
        Report an Issue
      </a>
    </header><!-- end of .page-header -->
    
      <article class="main lang-page" role="main">

      <header class="docs-header">
          <div class="versions">
            <a href="/gcloud-python/versions.html" class="v-btn">
              <img src="_static/images/icon-arrow-bullet.svg" />
              Version History (aa56c9f)
            </a>
          </div><!-- end of .versions -->
          <div>
            <a href="https://github.com/GoogleCloudPlatform/gcloud-python/issues/new?title=%5BDocumentation+Issue%5D+" target="_blank" class="v-btn" id="file-issue-secondary">
              <img src="_static/images/icon-link-github.svg" />
              Report an Issue
            </a>
          </div>
      </header>

      <section class="content">
        
  <h1>Source code for gcloud.bigtable.happybase.batch</h1><div class="highlight"><pre>
<span></span><span class="c1"># Copyright 2016 Google Inc. All rights reserved.</span>
<span class="c1">#</span>
<span class="c1"># Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<span class="c1"># you may not use this file except in compliance with the License.</span>
<span class="c1"># You may obtain a copy of the License at</span>
<span class="c1">#</span>
<span class="c1">#     http://www.apache.org/licenses/LICENSE-2.0</span>
<span class="c1">#</span>
<span class="c1"># Unless required by applicable law or agreed to in writing, software</span>
<span class="c1"># distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span class="c1"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span class="c1"># See the License for the specific language governing permissions and</span>
<span class="c1"># limitations under the License.</span>

<span class="sd">&quot;&quot;&quot;Google Cloud Bigtable HappyBase batch module.&quot;&quot;&quot;</span>


<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">warnings</span>

<span class="kn">import</span> <span class="nn">six</span>

<span class="kn">from</span> <span class="nn">gcloud._helpers</span> <span class="kn">import</span> <span class="n">_datetime_from_microseconds</span>
<span class="kn">from</span> <span class="nn">gcloud.bigtable.row_filters</span> <span class="kn">import</span> <span class="n">TimestampRange</span>


<span class="n">_WAL_SENTINEL</span> <span class="o">=</span> <span class="nb">object</span><span class="p">()</span>
<span class="c1"># Assumed granularity of timestamps in Cloud Bigtable.</span>
<span class="n">_ONE_MILLISECOND</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">microseconds</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
<span class="n">_WARN</span> <span class="o">=</span> <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span>
<span class="n">_WAL_WARNING</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;The wal argument (Write-Ahead-Log) is not &#39;</span>
                <span class="s1">&#39;supported by Cloud Bigtable.&#39;</span><span class="p">)</span>


<div class="viewcode-block" id="Batch"><a class="viewcode-back" href="../../../../happybase-batch.html#gcloud.bigtable.happybase.batch.Batch">[docs]</a><span class="k">class</span> <span class="nc">Batch</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Batch class for accumulating mutations.</span>

<span class="sd">    .. note::</span>

<span class="sd">       When using a batch with ``transaction=False`` as a context manager</span>
<span class="sd">       (i.e. in a ``with`` statement), mutations will still be sent as</span>
<span class="sd">       row mutations even if the context manager exits with an error.</span>
<span class="sd">       This behavior is in place to match the behavior in the HappyBase</span>
<span class="sd">       HBase / Thrift implementation.</span>

<span class="sd">    :type table: :class:`Table &lt;gcloud.bigtable.happybase.table.Table&gt;`</span>
<span class="sd">    :param table: The table where mutations will be applied.</span>

<span class="sd">    :type timestamp: int</span>
<span class="sd">    :param timestamp: (Optional) Timestamp (in milliseconds since the epoch)</span>
<span class="sd">                      that all mutations will be applied at.</span>

<span class="sd">    :type batch_size: int</span>
<span class="sd">    :param batch_size: (Optional) The maximum number of mutations to allow</span>
<span class="sd">                       to accumulate before committing them.</span>

<span class="sd">    :type transaction: bool</span>
<span class="sd">    :param transaction: Flag indicating if the mutations should be sent</span>
<span class="sd">                        transactionally or not. If ``transaction=True`` and</span>
<span class="sd">                        an error occurs while a :class:`Batch` is active,</span>
<span class="sd">                        then none of the accumulated mutations will be</span>
<span class="sd">                        committed. If ``batch_size`` is set, the mutation</span>
<span class="sd">                        can&#39;t be transactional.</span>

<span class="sd">    :type wal: object</span>
<span class="sd">    :param wal: Unused parameter (Boolean for using the HBase Write Ahead Log).</span>
<span class="sd">                Provided for compatibility with HappyBase, but irrelevant for</span>
<span class="sd">                Cloud Bigtable since it does not have a Write Ahead Log.</span>

<span class="sd">    :raises: :class:`TypeError &lt;exceptions.TypeError&gt;` if ``batch_size``</span>
<span class="sd">             is set and ``transaction=True``.</span>
<span class="sd">             :class:`ValueError &lt;exceptions.ValueError&gt;` if ``batch_size``</span>
<span class="sd">             is not positive.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table</span><span class="p">,</span> <span class="n">timestamp</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="n">transaction</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">wal</span><span class="o">=</span><span class="n">_WAL_SENTINEL</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">wal</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">_WAL_SENTINEL</span><span class="p">:</span>
            <span class="n">_WARN</span><span class="p">(</span><span class="n">_WAL_WARNING</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">batch_size</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">transaction</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;When batch_size is set, a Batch cannot be &#39;</span>
                                <span class="s1">&#39;transactional&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">batch_size</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;batch_size must be positive&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_table</span> <span class="o">=</span> <span class="n">table</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_batch_size</span> <span class="o">=</span> <span class="n">batch_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_timestamp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_delete_range</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="c1"># Timestamp is in milliseconds, convert to microseconds.</span>
        <span class="k">if</span> <span class="n">timestamp</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_timestamp</span> <span class="o">=</span> <span class="n">_datetime_from_microseconds</span><span class="p">(</span><span class="mi">1000</span> <span class="o">*</span> <span class="n">timestamp</span><span class="p">)</span>
            <span class="c1"># For deletes, we get the very next timestamp (assuming timestamp</span>
            <span class="c1"># granularity is milliseconds). This is because HappyBase users</span>
            <span class="c1"># expect HBase deletes to go **up to** and **including** the</span>
            <span class="c1"># timestamp while Cloud Bigtable Time Ranges **exclude** the</span>
            <span class="c1"># final timestamp.</span>
            <span class="n">next_timestamp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_timestamp</span> <span class="o">+</span> <span class="n">_ONE_MILLISECOND</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_delete_range</span> <span class="o">=</span> <span class="n">TimestampRange</span><span class="p">(</span><span class="n">end</span><span class="o">=</span><span class="n">next_timestamp</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_transaction</span> <span class="o">=</span> <span class="n">transaction</span>

        <span class="c1"># Internal state for tracking mutations.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_row_map</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_mutation_count</span> <span class="o">=</span> <span class="mi">0</span>

<div class="viewcode-block" id="Batch.send"><a class="viewcode-back" href="../../../../happybase-batch.html#gcloud.bigtable.happybase.batch.Batch.send">[docs]</a>    <span class="k">def</span> <span class="nf">send</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Send / commit the batch of mutations to the server.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_row_map</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="c1"># commit() does nothing if row hasn&#39;t accumulated any mutations.</span>
            <span class="n">row</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_row_map</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_mutation_count</span> <span class="o">=</span> <span class="mi">0</span></div>

    <span class="k">def</span> <span class="nf">_try_send</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Send / commit the batch if mutations have exceeded batch size.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_batch_size</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mutation_count</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_batch_size</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_get_row</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">row_key</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Gets a row that will hold mutations.</span>

<span class="sd">        If the row is not already cached on the current batch, a new row will</span>
<span class="sd">        be created.</span>

<span class="sd">        :type row_key: str</span>
<span class="sd">        :param row_key: The row key for a row stored in the map.</span>

<span class="sd">        :rtype: :class:`Row &lt;gcloud.bigtable.row.Row&gt;`</span>
<span class="sd">        :returns: The newly created or stored row that will hold mutations.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">row_key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_row_map</span><span class="p">:</span>
            <span class="n">table</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="o">.</span><span class="n">_low_level_table</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_row_map</span><span class="p">[</span><span class="n">row_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">row</span><span class="p">(</span><span class="n">row_key</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_row_map</span><span class="p">[</span><span class="n">row_key</span><span class="p">]</span>

<div class="viewcode-block" id="Batch.put"><a class="viewcode-back" href="../../../../happybase-batch.html#gcloud.bigtable.happybase.batch.Batch.put">[docs]</a>    <span class="k">def</span> <span class="nf">put</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">wal</span><span class="o">=</span><span class="n">_WAL_SENTINEL</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Insert data into a row in the table owned by this batch.</span>

<span class="sd">        :type row: str</span>
<span class="sd">        :param row: The row key where the mutation will be &quot;put&quot;.</span>

<span class="sd">        :type data: dict</span>
<span class="sd">        :param data: Dictionary containing the data to be inserted. The keys</span>
<span class="sd">                     are columns names (of the form ``fam:col``) and the values</span>
<span class="sd">                     are strings (bytes) to be stored in those columns.</span>

<span class="sd">        :type wal: object</span>
<span class="sd">        :param wal: Unused parameter (to over-ride the default on the</span>
<span class="sd">                    instance). Provided for compatibility with HappyBase, but</span>
<span class="sd">                    irrelevant for Cloud Bigtable since it does not have a</span>
<span class="sd">                    Write Ahead Log.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">wal</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">_WAL_SENTINEL</span><span class="p">:</span>
            <span class="n">_WARN</span><span class="p">(</span><span class="n">_WAL_WARNING</span><span class="p">)</span>

        <span class="n">row_object</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_row</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
        <span class="c1"># Make sure all the keys are valid before beginning</span>
        <span class="c1"># to add mutations.</span>
        <span class="n">column_pairs</span> <span class="o">=</span> <span class="n">_get_column_pairs</span><span class="p">(</span><span class="n">six</span><span class="o">.</span><span class="n">iterkeys</span><span class="p">(</span><span class="n">data</span><span class="p">),</span>
                                         <span class="n">require_qualifier</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">column_family_id</span><span class="p">,</span> <span class="n">column_qualifier</span> <span class="ow">in</span> <span class="n">column_pairs</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">column_family_id</span> <span class="o">+</span> <span class="s1">&#39;:&#39;</span> <span class="o">+</span> <span class="n">column_qualifier</span><span class="p">]</span>
            <span class="n">row_object</span><span class="o">.</span><span class="n">set_cell</span><span class="p">(</span><span class="n">column_family_id</span><span class="p">,</span> <span class="n">column_qualifier</span><span class="p">,</span>
                                <span class="n">value</span><span class="p">,</span> <span class="n">timestamp</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_timestamp</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_mutation_count</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_try_send</span><span class="p">()</span></div>

    <span class="k">def</span> <span class="nf">_delete_columns</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">columns</span><span class="p">,</span> <span class="n">row_object</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Adds delete mutations for a list of columns and column families.</span>

<span class="sd">        :type columns: list</span>
<span class="sd">        :param columns: Iterable containing column names (as</span>
<span class="sd">                        strings). Each column name can be either</span>

<span class="sd">                          * an entire column family: ``fam`` or ``fam:``</span>
<span class="sd">                          * a single column: ``fam:col``</span>

<span class="sd">        :type row_object: :class:`Row &lt;gcloud_bigtable.row.Row&gt;`</span>
<span class="sd">        :param row_object: The row which will hold the delete mutations.</span>

<span class="sd">        :raises: :class:`ValueError &lt;exceptions.ValueError&gt;` if the delete</span>
<span class="sd">                 timestamp range is set on the current batch, but a</span>
<span class="sd">                 column family delete is attempted.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">column_pairs</span> <span class="o">=</span> <span class="n">_get_column_pairs</span><span class="p">(</span><span class="n">columns</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">column_family_id</span><span class="p">,</span> <span class="n">column_qualifier</span> <span class="ow">in</span> <span class="n">column_pairs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">column_qualifier</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_delete_range</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;The Cloud Bigtable API does not support &#39;</span>
                                     <span class="s1">&#39;adding a timestamp to &#39;</span>
                                     <span class="s1">&#39;&quot;DeleteFromFamily&quot; &#39;</span><span class="p">)</span>
                <span class="n">row_object</span><span class="o">.</span><span class="n">delete_cells</span><span class="p">(</span><span class="n">column_family_id</span><span class="p">,</span>
                                        <span class="n">columns</span><span class="o">=</span><span class="n">row_object</span><span class="o">.</span><span class="n">ALL_COLUMNS</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">row_object</span><span class="o">.</span><span class="n">delete_cell</span><span class="p">(</span><span class="n">column_family_id</span><span class="p">,</span>
                                       <span class="n">column_qualifier</span><span class="p">,</span>
                                       <span class="n">time_range</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_delete_range</span><span class="p">)</span>

<div class="viewcode-block" id="Batch.delete"><a class="viewcode-back" href="../../../../happybase-batch.html#gcloud.bigtable.happybase.batch.Batch.delete">[docs]</a>    <span class="k">def</span> <span class="nf">delete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">wal</span><span class="o">=</span><span class="n">_WAL_SENTINEL</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Delete data from a row in the table owned by this batch.</span>

<span class="sd">        :type row: str</span>
<span class="sd">        :param row: The row key where the delete will occur.</span>

<span class="sd">        :type columns: list</span>
<span class="sd">        :param columns: (Optional) Iterable containing column names (as</span>
<span class="sd">                        strings). Each column name can be either</span>

<span class="sd">                          * an entire column family: ``fam`` or ``fam:``</span>
<span class="sd">                          * a single column: ``fam:col``</span>

<span class="sd">                        If not used, will delete the entire row.</span>

<span class="sd">        :type wal: object</span>
<span class="sd">        :param wal: Unused parameter (to over-ride the default on the</span>
<span class="sd">                    instance). Provided for compatibility with HappyBase, but</span>
<span class="sd">                    irrelevant for Cloud Bigtable since it does not have a</span>
<span class="sd">                    Write Ahead Log.</span>

<span class="sd">        :raises: If the delete timestamp range is set on the</span>
<span class="sd">                 current batch, but a full row delete is attempted.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">wal</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">_WAL_SENTINEL</span><span class="p">:</span>
            <span class="n">_WARN</span><span class="p">(</span><span class="n">_WAL_WARNING</span><span class="p">)</span>

        <span class="n">row_object</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_row</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">columns</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="c1"># Delete entire row.</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_delete_range</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;The Cloud Bigtable API does not support &#39;</span>
                                 <span class="s1">&#39;adding a timestamp to &quot;DeleteFromRow&quot; &#39;</span>
                                 <span class="s1">&#39;mutations&#39;</span><span class="p">)</span>
            <span class="n">row_object</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_mutation_count</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_delete_columns</span><span class="p">(</span><span class="n">columns</span><span class="p">,</span> <span class="n">row_object</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_mutation_count</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">columns</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_try_send</span><span class="p">()</span></div>

    <span class="k">def</span> <span class="nf">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Enter context manager, no set-up required.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_value</span><span class="p">,</span> <span class="n">traceback</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Exit context manager, no set-up required.</span>

<span class="sd">        :type exc_type: type</span>
<span class="sd">        :param exc_type: The type of the exception if one occurred while the</span>
<span class="sd">                         context manager was active. Otherwise, :data:`None`.</span>

<span class="sd">        :type exc_value: :class:`Exception &lt;exceptions.Exception&gt;`</span>
<span class="sd">        :param exc_value: An instance of ``exc_type`` if an exception occurred</span>
<span class="sd">                          while the context was active.</span>
<span class="sd">                          Otherwise, :data:`None`.</span>

<span class="sd">        :type traceback: ``traceback`` type</span>
<span class="sd">        :param traceback: The traceback where the exception occurred (if one</span>
<span class="sd">                          did occur). Otherwise, :data:`None`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># If the context manager encountered an exception and the batch is</span>
        <span class="c1"># transactional, we don&#39;t commit the mutations.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_transaction</span> <span class="ow">and</span> <span class="n">exc_type</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="c1"># NOTE: For non-transactional batches, this will even commit mutations</span>
        <span class="c1">#       if an error occurred during the context manager.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">()</span></div>


<span class="k">def</span> <span class="nf">_get_column_pairs</span><span class="p">(</span><span class="n">columns</span><span class="p">,</span> <span class="n">require_qualifier</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Turns a list of column or column families into parsed pairs.</span>

<span class="sd">    Turns a column family (``fam`` or ``fam:``) into a pair such</span>
<span class="sd">    as ``[&#39;fam&#39;, None]`` and turns a column (``fam:col``) into</span>
<span class="sd">    ``[&#39;fam&#39;, &#39;col&#39;]``.</span>

<span class="sd">    :type columns: list</span>
<span class="sd">    :param columns: Iterable containing column names (as</span>
<span class="sd">                    strings). Each column name can be either</span>

<span class="sd">                      * an entire column family: ``fam`` or ``fam:``</span>
<span class="sd">                      * a single column: ``fam:col``</span>

<span class="sd">    :type require_qualifier: bool</span>
<span class="sd">    :param require_qualifier: Boolean indicating if the columns should</span>
<span class="sd">                              all have a qualifier or not.</span>

<span class="sd">    :rtype: list</span>
<span class="sd">    :returns: List of pairs, where the first element in each pair is the</span>
<span class="sd">              column family and the second is the column qualifier</span>
<span class="sd">              (or :data:`None`).</span>
<span class="sd">    :raises: :class:`ValueError &lt;exceptions.ValueError&gt;` if any of the columns</span>
<span class="sd">             are not of the expected format.</span>
<span class="sd">             :class:`ValueError &lt;exceptions.ValueError&gt;` if</span>
<span class="sd">             ``require_qualifier`` is :data:`True` and one of the values is</span>
<span class="sd">             for an entire column family</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">column_pairs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">columns</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">column</span><span class="p">,</span> <span class="n">six</span><span class="o">.</span><span class="n">binary_type</span><span class="p">):</span>
            <span class="n">column</span> <span class="o">=</span> <span class="n">column</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
        <span class="c1"># Remove trailing colons (i.e. for standalone column family).</span>
        <span class="k">if</span> <span class="n">column</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">u&#39;:&#39;</span><span class="p">):</span>
            <span class="n">column</span> <span class="o">=</span> <span class="n">column</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">num_colons</span> <span class="o">=</span> <span class="n">column</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s1">u&#39;:&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">num_colons</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># column is a column family.</span>
            <span class="k">if</span> <span class="n">require_qualifier</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;column does not contain a qualifier&#39;</span><span class="p">,</span>
                                 <span class="n">column</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">column_pairs</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">column</span><span class="p">,</span> <span class="bp">None</span><span class="p">])</span>
        <span class="k">elif</span> <span class="n">num_colons</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">column_pairs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">column</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">u&#39;:&#39;</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Column contains the : separator more than once&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">column_pairs</span>
</pre></div>

      </section><!-- end of .content -->
      <nav class="side-nav">
        <p class="caption"><span class="caption-text">gcloud</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../gcloud-api.html">Shared Core Modules</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../gcloud-config.html">Configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../gcloud-auth.html">Authentication</a></li>
</ul>
<p class="caption"><span class="caption-text">Datastore</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../datastore-client.html">Client</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../datastore-entities.html">Entities</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../datastore-keys.html">Keys</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../datastore-queries.html">Queries</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../datastore-transactions.html">Transactions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../datastore-batches.html">Batches</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../datastore-helpers.html">Helpers</a></li>
</ul>
<p class="caption"><span class="caption-text">Storage</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../storage-client.html">Client</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../storage-blobs.html">Blobs / Objects</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../storage-buckets.html">Buckets</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../storage-acl.html">ACL</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../storage-batch.html">Batches</a></li>
</ul>
<p class="caption"><span class="caption-text">Pub/Sub</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../pubsub-usage.html">Using the API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../pubsub-client.html">Client</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../pubsub-topic.html">Topics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../pubsub-subscription.html">Subscriptions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../pubsub-message.html">Message</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../pubsub-iam.html">IAM Policy</a></li>
</ul>
<p class="caption"><span class="caption-text">BigQuery</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../bigquery-usage.html">Using the API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../bigquery-client.html">Client</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../bigquery-dataset.html">Datasets</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../bigquery-job.html">Jobs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../bigquery-table.html">Tables</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../bigquery-query.html">Query</a></li>
</ul>
<p class="caption"><span class="caption-text">Cloud Bigtable</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../bigtable-usage.html">Using the API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../happybase-package.html">HappyBase</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../bigtable-client-intro.html">Base for Everything</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../bigtable-instance-api.html">Instance Admin API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../bigtable-table-api.html">Table Admin API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../bigtable-data-api.html">Data API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../bigtable-client.html">Client</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../bigtable-instance.html">Instance</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../bigtable-cluster.html">Cluster</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../bigtable-table.html">Table</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../bigtable-column-family.html">Column Families</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../bigtable-row.html">Bigtable Row</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../bigtable-row-filters.html">Bigtable Row Filters</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../bigtable-row-data.html">Row Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../happybase-connection.html">HappyBase Connection</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../happybase-pool.html">HappyBase Connection Pool</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../happybase-table.html">HappyBase Table</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../happybase-batch.html">HappyBase Batch</a></li>
</ul>
<p class="caption"><span class="caption-text">Resource Manager</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../resource-manager-api.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../resource-manager-client.html">Client</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../resource-manager-project.html">Projects</a></li>
</ul>
<p class="caption"><span class="caption-text">DNS</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../dns-usage.html">Using the API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../dns-client.html">Client</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../dns-zone.html">Managed Zones</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../dns-resource-record-set.html">Resource Record Sets</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../dns-changes.html">Change Sets</a></li>
</ul>
<p class="caption"><span class="caption-text">Stackdriver Logging</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../logging-usage.html">Using the API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../logging-client.html">Client</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../logging-logger.html">Logger</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../logging-entries.html">Entries</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../logging-metric.html">Metrics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../logging-sink.html">Sinks</a></li>
</ul>
<p class="caption"><span class="caption-text">Stackdriver Monitoring</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../monitoring-usage.html">Using the API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../monitoring-client.html">Client</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../monitoring-metric.html">Metric Descriptors</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../monitoring-resource.html">Monitored Resource Descriptors</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../monitoring-query.html">Time Series Query</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../monitoring-timeseries.html">Time Series</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../monitoring-label.html">Label Descriptors</a></li>
</ul>
<p class="caption"><span class="caption-text">Translate</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../translate-usage.html">Using the API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../translate-client.html">Client</a></li>
</ul>
<p class="caption"><span class="caption-text">External Links</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="https://github.com/GoogleCloudPlatform/gcloud-python/">GitHub</a></li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/GoogleCloudPlatform/gcloud-python/issues">Issues</a></li>
<li class="toctree-l1"><a class="reference external" href="http://stackoverflow.com/questions/tagged/gcloud-python">Stack Overflow</a></li>
<li class="toctree-l1"><a class="reference external" href="https://pypi.python.org/pypi/gcloud">PyPI</a></li>
</ul>

      </nav><!-- end of .side-nav -->
    </article><!-- end of .main -->

    <script src="../../../../_static/js/vendor/jquery-1.10.2.min.js"></script>
    <script src="../../../../_static/js/plugins.js"></script>
    <script src="../../../../_static/js/main.js"></script>
  
  </body>
</html>